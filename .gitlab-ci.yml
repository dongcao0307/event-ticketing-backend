image: maven:3.9.6-eclipse-temurin-21

stages:
  - build
  - test

cache:
  paths:
    - .m2/repository

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"

build_all_services:
  stage: build
  script:
    - echo "Đang tự động phát hiện và build các Microservices..."
    # Script này sẽ tìm mọi thư mục có pom.xml để build, không lo thiếu folder
    - |
      for pom in $(find . -maxdepth 2 -name "pom.xml" -not -path "./pom.xml"); do
        dir=$(dirname $pom)
        echo "--- Đang build service: $dir ---"
        cd $dir && mvn clean package -DskipTests && cd ..
      done
  artifacts:
    paths:
      - "*/target/*.jar"
    expire_in: 1 week

run_unit_tests:
  stage: test
  script:
    - echo "Đang chạy Unit Test cho service hiện có..."
    # Chỉ chạy test nếu thư mục auth-service tồn tại để tránh lỗi Pipeline
    - if [ -d "auth-service" ]; then cd auth-service && mvn test; else echo "Chưa có auth-service để test"; fi
  allow_failure: true
